<?php

namespace App\Http\Controllers;

use App\Models\ChatMessage;
use App\Models\NatalChart;
use App\Services\AiAstrologyService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;

class AstrologyChatController extends Controller
{
    protected $aiService;

    public function __construct(AiAstrologyService $aiService)
    {
        $this->aiService = $aiService;
    }

    public function index(NatalChart $natalChart)
    {
        // Ensure user owns the chart
        if ($natalChart->user_id !== Auth::id()) {
            abort(403);
        }

        return view('charts.chat', [
            'chart' => $natalChart,
            'templates' => $this->getTemplates(),
        ]);
    }

    public function send(Request $request, NatalChart $natalChart)
    {
        if ($natalChart->user_id !== Auth::id()) {
            abort(403);
        }

        $validated = $request->validate([
            'message' => 'required|string|max:1000',
            'template' => 'nullable|string',
        ]);

        $message = $validated['message'];
        $template = $validated['template'] ?? null;

        // If template selected, use it
        if ($template && isset($this->getTemplates()[$template])) {
            $message = $this->getTemplates()[$template]['prompt'];
        }

        // Save user message
        ChatMessage::create([
            'natal_chart_id' => $natalChart->id,
            'role' => 'user',
            'content' => $message,
        ]);

        $chartData = $natalChart->chart_data;

        try {
            Log::info('Chat message', ['chart_id' => $natalChart->id, 'template' => $template]);

            $response = $this->aiService->chat($message, $chartData);

            // Save assistant response
            ChatMessage::create([
                'natal_chart_id' => $natalChart->id,
                'role' => 'assistant',
                'content' => $response,
            ]);

            return response()->json([
                'message' => $response,
                'timestamp' => now()->toISOString(),
            ]);
        } catch (\Exception $e) {
            Log::error('Chat error: ' . $e->getMessage());
            return response()->json(['error' => 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð°'], 500);
        }
    }

    public function clear(NatalChart $natalChart)
    {
        if ($natalChart->user_id !== Auth::id()) {
            abort(403);
        }

        $natalChart->chatMessages()->delete();

        return response()->json(['success' => true]);
    }

    public function templates(): array
    {
        return [
            'character' => [
                'title' => 'ÐžÐ±Ñ‰Ð°Ñ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ°',
                'icon' => 'ðŸ‘¤',
                'prompt' => 'Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ Ð¾ Ð¼Ð¾ÐµÐ¹ Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚Ð¸ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¼Ð¾ÐµÐ¹ Ð½Ð°Ñ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÐºÐ°Ñ€Ñ‚Ñ‹. ÐšÐ°ÐºÐ¸Ðµ Ñ‡ÐµÑ€Ñ‚Ñ‹ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð° Ð²Ñ‹Ñ€Ð°Ð¶ÐµÐ½Ñ‹ ÑÐ¸Ð»ÑŒÐ½ÐµÐµ Ð²ÑÐµÐ³Ð¾? ÐšÐ°Ðº Ð¿Ñ€Ð¾ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¼Ð¾Ñ Ð¡Ð¾Ð»Ð½Ñ†Ðµ? ÐšÐ°ÐºÐ¾Ð¹ Ñƒ Ð¼ÐµÐ½Ñ ÐÑÑ†ÐµÐ½Ð´ÐµÐ½Ñ‚ Ð¸ ÐºÐ°Ðº Ð¾Ð½ Ð²Ð»Ð¸ÑÐµÑ‚ Ð½Ð° Ð¼Ð¾Ñ‘ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ?',
            ],
            'love' => [
                'title' => 'Ð›ÑŽÐ±Ð¾Ð²ÑŒ Ð¸ Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ñ',
                'icon' => 'ðŸ’•',
                'prompt' => 'ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð¼Ð¾ÑŽ ÐºÐ°Ñ€Ñ‚Ñƒ Ð² Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ñ… Ð»ÑŽÐ±Ð²Ð¸ Ð¸ Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ð¹. ÐšÐ°ÐºÐ¾Ð¹ Ñƒ Ð¼ÐµÐ½Ñ ÑÑ‚Ð¸Ð»ÑŒ Ð»ÑŽÐ±Ð²Ð¸? ÐšÐ°ÐºÐ¸Ðµ Ð¿Ð°Ñ€Ñ‚Ð½Ñ‘Ñ€Ñ‹ Ð¼Ð½Ðµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‚? ÐšÐ°Ðº Ð¿Ñ€Ð¾ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð’ÐµÐ½ÐµÑ€Ð° Ð¸ ÐœÐ°Ñ€Ñ Ð² Ð¼Ð¾ÐµÐ¹ ÐºÐ°Ñ€Ñ‚Ðµ? Ð§Ñ‚Ð¾ Ð¼Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð¾ Ð² Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸ÑÑ…?',
            ],
            'career' => [
                'title' => 'ÐšÐ°Ñ€ÑŒÐµÑ€Ð° Ð¸ Ð¿Ñ€Ð¸Ð·Ð²Ð°Ð½Ð¸Ðµ',
                'icon' => 'ðŸ’¼',
                'prompt' => 'Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¾ Ð¼Ð¾Ñ‘Ð¼ ÐºÐ°Ñ€ÑŒÐµÑ€Ð½Ð¾Ð¼ Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»Ðµ Ð¸ Ð¿Ñ€Ð¸Ð·Ð²Ð°Ð½Ð¸Ð¸. ÐšÐ°ÐºÐ¸Ðµ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¸ Ð¼Ð½Ðµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‚? ÐšÐ°ÐºÐ¾Ð¹ Ñƒ Ð¼ÐµÐ½Ñ 10 Ð´Ð¾Ð¼ Ð¸ ÐœÐ¡? ÐšÐ°Ðº Ð¿Ñ€Ð¾ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¡Ð°Ñ‚ÑƒÑ€Ð½ Ð² ÐºÐ°Ñ€ÑŒÐµÑ€Ðµ? Ð•ÑÑ‚ÑŒ Ð»Ð¸ Ñƒ Ð¼ÐµÐ½Ñ Ð»Ð¸Ð´ÐµÑ€ÑÐºÐ¸Ðµ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°?',
            ],
            'finance' => [
                'title' => 'Ð¤Ð¸Ð½Ð°Ð½ÑÑ‹ Ð¸ Ð´ÐµÐ½ÑŒÐ³Ð¸',
                'icon' => 'ðŸ’°',
                'prompt' => 'ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð¼Ð¾ÑŽ ÐºÐ°Ñ€Ñ‚Ñƒ Ð² Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ñ… Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð². ÐšÐ°Ðº Ñ Ð¾Ñ‚Ð½Ð¾ÑˆÑƒÑÑŒ Ðº Ð´ÐµÐ½ÑŒÐ³Ð°Ð¼? ÐšÐ°ÐºÐ¸Ðµ Ð´Ð¾Ð¼Ð° Ð¸ Ð¿Ð»Ð°Ð½ÐµÑ‚Ñ‹ Ð²Ð»Ð¸ÑÑŽÑ‚ Ð½Ð° Ð¼Ð¾Ð¸ Ð´Ð¾Ñ…Ð¾Ð´Ñ‹? Ð•ÑÑ‚ÑŒ Ð»Ð¸ ÑÐºÐ»Ð¾Ð½Ð½Ð¾ÑÑ‚ÑŒ Ðº Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸ÑŽ Ð¸Ð»Ð¸ Ñ‚Ñ€Ð°Ñ‚Ð°Ð¼? ÐšÐ°Ðº ÑƒÐ»ÑƒÑ‡ÑˆÐ¸Ñ‚ÑŒ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾Ðµ Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ?',
            ],
            'health' => [
                'title' => 'Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ',
                'icon' => 'ðŸ¥',
                'prompt' => 'Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¾ Ð¼Ð¾Ñ‘Ð¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÐºÐ°Ñ€Ñ‚Ñ‹. ÐšÐ°ÐºÐ¸Ðµ Ð¾Ñ€Ð³Ð°Ð½Ñ‹ Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ ÑƒÑÐ·Ð²Ð¸Ð¼Ñ‹? Ð•ÑÑ‚ÑŒ Ð»Ð¸ Ð¿Ñ€ÐµÐ´Ñ€Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ðº Ð·Ð°Ð±Ð¾Ð»ÐµÐ²Ð°Ð½Ð¸ÑÐ¼? ÐšÐ°ÐºÐ¸Ðµ Ð°ÑÐ¿ÐµÐºÑ‚Ñ‹ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ Ð½Ð° ÑÐ¸Ð»Ñƒ Ð¸Ð»Ð¸ ÑÐ»Ð°Ð±Ð¾ÑÑ‚ÑŒ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð¼Ð°?',
            ],
            'compatibility' => [
                'title' => 'Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ',
                'icon' => 'ðŸ”®',
                'prompt' => 'ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð¼Ð¾ÑŽ Ð½Ð°Ñ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ ÐºÐ°Ñ€Ñ‚Ñƒ Ð½Ð° Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ð¹. ÐšÐ°ÐºÐ¸Ðµ Ð·Ð½Ð°ÐºÐ¸ Ð¼Ð½Ðµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‚ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð²ÑÐµÐ³Ð¾? ÐšÐ°ÐºÐ¸Ðµ Ñƒ Ð¼ÐµÐ½Ñ ÐµÑÑ‚ÑŒ Ð²Ñ‹Ð·Ð¾Ð²Ñ‹ Ð² Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸ÑÑ…? ÐšÐ°Ðº Ð¿Ñ€Ð¾ÑÐ²Ð»ÑÐµÑ‚ÑÑ 7 Ð´Ð¾Ð¼?',
            ],
            'karmic' => [
                'title' => 'ÐšÐ°Ñ€Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿ÑƒÑ‚ÑŒ',
                'icon' => 'âœ¨',
                'prompt' => 'Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¾ Ð¼Ð¾Ñ‘Ð¼ ÐºÐ°Ñ€Ð¼Ð¸Ñ‡ÐµÑÐºÐ¾Ð¼ Ð¿ÑƒÑ‚Ð¸. ÐšÐ°ÐºÐ¸Ðµ ÑƒÑ€Ð¾ÐºÐ¸ Ñ Ð¿Ñ€Ð¸Ð½Ñ‘Ñ Ð¸Ð· Ð¿Ñ€Ð¾ÑˆÐ»Ñ‹Ñ… Ð²Ð¾Ð¿Ð»Ð¾Ñ‰ÐµÐ½Ð¸Ð¹? ÐšÐ°Ðº Ð¿Ñ€Ð¾ÑÐ²Ð»ÑÑŽÑ‚ÑÑ ÑƒÐ·Ð»Ñ‹ Ð›ÑƒÐ½Ñ‹? ÐšÐ°ÐºÐ¸Ðµ Ñ€ÐµÑ‚Ñ€Ð¾Ð³Ñ€Ð°Ð´Ð½Ñ‹Ðµ Ð¿Ð»Ð°Ð½ÐµÑ‚Ñ‹ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ Ð½Ð° ÐºÐ°Ñ€Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸?',
            ],
            'transits' => [
                'title' => 'ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð· Ð¸ Ñ‚Ñ€Ð°Ð½Ð·Ð¸Ñ‚Ñ‹',
                'icon' => 'ðŸŒŸ',
                'prompt' => 'ÐšÐ°ÐºÐ¸Ðµ Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ñ‚Ñ€Ð°Ð½Ð·Ð¸Ñ‚Ñ‹ Ð¸ Ð°ÑÐ¿ÐµÐºÑ‚Ñ‹ Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‚ Ð¼ÐµÐ½Ñ Ð² Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐµ Ð²Ñ€ÐµÐ¼Ñ? ÐÐ° Ñ‡Ñ‚Ð¾ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ? ÐšÐ°ÐºÐ¸Ðµ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð±Ð»Ð°Ð³Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð½Ñ‹Ð¼Ð¸, Ð° ÐºÐ°ÐºÐ¸Ðµ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸?',
            ],
            'strengths' => [
                'title' => 'Ð¡Ð¸Ð»ÑŒÐ½Ñ‹Ðµ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹',
                'icon' => 'ðŸ’ª',
                'prompt' => 'Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¾ Ð¼Ð¾Ð¸Ñ… ÑÐ¸Ð»ÑŒÐ½Ñ‹Ñ… ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð°Ñ… Ð¸ Ñ‚Ð°Ð»Ð°Ð½Ñ‚Ð°Ñ… Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÐºÐ°Ñ€Ñ‚Ñ‹. ÐšÐ°ÐºÐ¸Ðµ Ð¿Ð»Ð°Ð½ÐµÑ‚Ñ‹ Ð´Ð°ÑŽÑ‚ Ð¼Ð½Ðµ ÑÐ¸Ð»Ñƒ? Ð’ Ñ‡Ñ‘Ð¼ Ñ Ð¼Ð¾Ð³Ñƒ Ð¿Ñ€ÐµÑƒÑÐ¿ÐµÑ‚ÑŒ? ÐšÐ°ÐºÐ¸Ðµ Ð´Ð°Ñ€Ñ‹ Ñ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð» Ð¾Ñ‚ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ?',
            ],
            'challenges' => [
                'title' => 'Ð’Ñ‹Ð·Ð¾Ð²Ñ‹ Ð¸ ÑÐ»Ð°Ð±Ð¾ÑÑ‚Ð¸',
                'icon' => 'ðŸ§—',
                'prompt' => 'ÐÐ° ÐºÐ°ÐºÐ¸Ðµ Ð¼Ð¾Ð¸ ÑÐ»Ð°Ð±Ñ‹Ðµ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹ Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ñ‹ Ð¼Ð½Ðµ ÑÑ‚Ð¾Ð¸Ñ‚ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ? ÐšÐ°ÐºÐ¸Ðµ Ð°ÑÐ¿ÐµÐºÑ‚Ñ‹ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ Ð½Ð° Ñ‚Ñ€ÑƒÐ´Ð½Ð¾ÑÑ‚Ð¸? ÐšÐ°Ðº Ð»ÑƒÑ‡ÑˆÐµ Ð²ÑÐµÐ³Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ñ Ð¼Ð¾Ð¸Ð¼Ð¸ ÑÐ»Ð°Ð±Ð¾ÑÑ‚ÑÐ¼Ð¸?',
            ],
        ];
    }

    public function getTemplates(): array
    {
        return $this->templates();
    }
}
