; Supervisor configuration for natalnaya-karta
; Server: VDS-KVM-SSD 2 CPU, 4GB RAM, 60GB SSD
;
; Install: sudo apt install supervisor
; Copy this file to: /etc/supervisor/conf.d/laravel-worker.conf
; Then run:
;   sudo supervisorctl reread
;   sudo supervisorctl update
;   sudo supervisorctl start all

; ===========================================
; CHAT QUEUE - High Priority (fast responses)
; 2 workers - users expect quick replies
; ===========================================
[program:laravel-chat]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/natalnaya-karta/artisan queue:work database --queue=chat --sleep=1 --tries=2 --timeout=120 --memory=256
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/natalnaya-karta/storage/logs/worker-chat.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stopwaitsecs=3600

; ===========================================
; AI REPORTS QUEUE - Lower Priority
; 2 workers - reports take long, parallel helps
; ===========================================
[program:laravel-ai-reports]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/natalnaya-karta/artisan queue:work database --queue=ai-reports --sleep=3 --tries=3 --timeout=300 --memory=512
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/natalnaya-karta/storage/logs/worker-ai-reports.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stopwaitsecs=3600

; ===========================================
; DEFAULT QUEUE - Emails and misc
; 1 worker - emails are not time-critical
; ===========================================
[program:laravel-default]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/natalnaya-karta/artisan queue:work database --queue=default --sleep=3 --tries=3 --timeout=60 --memory=128
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/www/natalnaya-karta/storage/logs/worker-default.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stopwaitsecs=3600

; ===========================================
; GROUP - Manage all workers together
; ===========================================
[group:laravel-workers]
programs=laravel-chat,laravel-ai-reports,laravel-default
priority=999
